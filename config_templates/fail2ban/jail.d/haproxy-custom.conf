# ======================================================================
# Fail2Ban Jail Configuration for Custom HAProxy Rules
# Generated by: deploy_proxy_platform.sh
# Purpose: Define jails using the haproxy-custom filter to ban IPs.
# Location: /etc/fail2ban/jail.d/haproxy-custom.conf
# ======================================================================

# ----------------------------------------------------------------------
# Jail: haproxy-http-drop
# Bans IPs triggering silent drops on HTTP/S frontends (VLESS, Subscription)
# ----------------------------------------------------------------------
[haproxy-http-drop]
enabled  = true
port     = ${SUBSCRIPTION_SITE_PORT},${VLESS_HTTPUPGRADE_PORT}
filter   = haproxy-custom
logpath  = /var/log/haproxy.log
maxretry = ${FAIL2BAN_MAXRETRY}
findtime = ${FAIL2BAN_FINDTIME}
bantime  = ${FAIL2BAN_BANTIME}
# CORRECTED action:
# The 'name' parameter for iptables-multiport is the name of the iptables chain.
# We can hardcode it or use the actual jail name.
# Let's use the actual jail name 'haproxy-http-drop' directly.
action   = iptables-multiport[name="haproxy-http-drop", port="%(port)s", protocol="tcp"]

# ----------------------------------------------------------------------
# Jail: haproxy-udp-reject
# Bans IPs triggering connection rejects on the UDP frontend (Hysteria2)
# ----------------------------------------------------------------------
[haproxy-udp-reject]
enabled  = true
port     = ${HYSTERIA2_PORT}
filter   = haproxy-custom
logpath  = /var/log/haproxy.log
maxretry = ${FAIL2BAN_MAXRETRY}
findtime = ${FAIL2BAN_FINDTIME}
bantime  = ${FAIL2BAN_BANTIME}
# CORRECTED action:
# Use the actual jail name 'haproxy-udp-reject' for the iptables chain name.
action   = iptables-multiport[name="haproxy-udp-reject", port="%(port)s", protocol="udp"]

# ======================================================================
# End of Fail2Ban Jail Configuration
# ======================================================================
