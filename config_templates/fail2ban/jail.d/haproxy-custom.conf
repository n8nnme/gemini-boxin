# ======================================================================
# Fail2Ban Jail Configuration for Custom HAProxy Rules
# Generated by: deploy_proxy_platform.sh
# Purpose: Define jails using the haproxy-custom filter to ban IPs.
# Location: /etc/fail2ban/jail.d/haproxy-custom.conf
# ======================================================================

# ----------------------------------------------------------------------
# Jail: haproxy-http-drop
# Bans IPs triggering silent drops on HTTP/S frontends (VLESS, Subscription)
# ----------------------------------------------------------------------
[haproxy-http-drop]
# Enable this jail
enabled  = true

# Specify the ports associated with the HTTP frontends being monitored
# Fail2ban uses this for context and potentially in the ban action.
# Use the placeholder syntax %(port)s in the action string below.
port     = ${SUBSCRIPTION_SITE_PORT},${VLESS_HTTPUPGRADE_PORT}

# Use the custom filter defined in filter.d/haproxy-custom.conf
filter   = haproxy-custom

# Path to the HAProxy log file that Fail2ban should monitor
# Ensure this path is correct and readable by the Fail2ban process.
# Also ensure HAProxy is actually logging to this file (via rsyslog).
logpath  = /var/log/haproxy.log

# Number of matches (failures) before banning
maxretry = ${FAIL2BAN_MAXRETRY}

# Time window (e.g., 10m, 1h) within which maxretry failures must occur
findtime = ${FAIL2BAN_FINDTIME}

# Duration of the ban (e.g., 1h, 1d, -1 for permanent)
bantime  = ${FAIL2BAN_BANTIME}

# Action to take when banning. Uses iptables-multiport to block
# the specified TCP ports for the offending IP.
# %(name)s = jail name (haproxy-http-drop)
# %(port)s = port list defined above
# %(protocol)s = tcp (defined here)
action   = iptables-multiport[name="%(name)s", port="%(port)s", protocol="tcp"]

# ----------------------------------------------------------------------
# Jail: haproxy-udp-reject
# Bans IPs triggering connection rejects on the UDP frontend (Hysteria2)
# ----------------------------------------------------------------------
[haproxy-udp-reject]
# Enable this jail
enabled  = true

# Specify the UDP port associated with the Hysteria2 frontend
port     = ${HYSTERIA2_PORT}

# Use the same custom filter (it includes patterns for PR-- flags)
filter   = haproxy-custom

# Monitor the same HAProxy log file
logpath  = /var/log/haproxy.log

# Number of matches before banning (can be same or different from HTTP)
maxretry = ${FAIL2BAN_MAXRETRY}

# Time window for UDP rejects
findtime = ${FAIL2BAN_FINDTIME}

# Duration of the ban for UDP offenders
bantime  = ${FAIL2BAN_BANTIME}

# Action using iptables-multiport to block the specified UDP port
action   = iptables-multiport[name="%(name)s", port="%(port)s", protocol="udp"]

# ======================================================================
# End of Fail2Ban Jail Configuration
# ======================================================================
