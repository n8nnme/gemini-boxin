{
  // ======================================================================
  // Sing-Box Configuration Template
  // Generated by: deploy_proxy_platform.sh
  // Purpose: Define VLESS and Hysteria2 backend services listening locally.
  // Location: /etc/sing-box/config.json
  // ======================================================================

  "log": {
    // Log level (options: trace, debug, info, warn, error, fatal, panic)
    "level": "info",
    // Include timestamps in log messages
    "timestamp": true
  },

  "inbounds": [
    // --- VLESS Inbound ---
    // Receives connections from HAProxy for the VLESS service
    {
      "type": "vless",
      "tag": "vless-in",
      // Listen only on the loopback interface
      "listen": "127.0.0.1",
      // Listen on the internal port designated for VLESS
      "listen_port": ${SINGBOX_VLESS_LISTEN_PORT}, // e.g., 10001
      // User authentication section.
      // The deployment script initializes this as empty.
      // Users (UUIDs) are added/removed using the manage_proxy_users.sh script.
      "users": [],
      // Transport configuration MUST match HAProxy setup
      "transport": {
        "type": "http", // Expecting plain HTTP from HAProxy for upgrade
        "path": "${VLESS_PATH}" // The secret VLESS path
      }
    },

    // --- Hysteria2 Inbound ---
    // Receives UDP connections from HAProxy for the Hysteria2 service
    {
      "type": "hysteria2",
      "tag": "hysteria2-in",
      // Listen only on the loopback interface
      "listen": "127.0.0.1",
      // Listen on the internal UDP port designated for Hysteria2
      "listen_port": ${SINGBOX_HYSTERIA2_LISTEN_PORT}, // e.g., 10002
      // Bandwidth settings (adjust based on server capabilities)
      "up_mbps": 100,
      "down_mbps": 500,
      // Authentication password MUST match the client configuration
      "password": "${HYSTERIA2_PASSWORD}",
      // TLS configuration for Hysteria2 itself (HAProxy just forwards UDP)
      "tls": {
        "enabled": true,
        // Server Name Indication (SNI), should match the main domain
        "server_name": "${MAIN_DOMAIN}",
        // ALPN values for Hysteria2 (typically h3)
        "alpn": ["h3"],
        // Path to the certificate and key files obtained via Certbot
        // Permissions must allow the 'singbox' user to read these.
        "certificate_path": "${SINGBOX_CERT_DIR}/hysteria2.cert.pem",
        "key_path": "${SINGBOX_CERT_DIR}/hysteria2.key.pem"
        // "insecure": false, // Default, set to true only if using self-signed certs AND client is configured to skip verification
      }
      // Optional: Obfuscation settings can be added here if needed
      // "obfs": { "type": "salamander", "password": "your_obfs_password" }
    }
  ],

  "outbounds": [
    // Default outbound: Direct connection to the internet
    {
      "type": "direct",
      "tag": "direct-out"
    },
    // Default block outbound (useful for routing rules)
    {
      "type": "block",
      "tag": "block-out"
    }
    // Add other outbounds here if needed (e.g., other proxies)
  ],

  "route": {
    // Routing rules define how traffic from inbounds is directed to outbounds
    "rules": [
      {
        // Route traffic from both VLESS and Hysteria2 inbounds
        "inbound": ["vless-in", "hysteria2-in"],
        // Send it directly out to the internet
        "outbound": "direct-out"
      }
      // Add more specific rules here if needed (e.g., based on domain, port, IP)
    ]
    // Optional: Define a final outbound if no rules match
    // "final": "direct-out"
  }
}
