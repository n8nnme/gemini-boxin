# ======================================================================
# HAProxy Configuration Template
# Generated by: deploy_proxy_platform.sh
# Purpose: Frontend routing, TLS termination, rate limiting, obscurity.
# ======================================================================

global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners user ${HAPROXY_USER} group ${HAPROXY_GROUP}
    stats timeout 30s
    user ${HAPROXY_USER}
    group ${HAPROXY_GROUP}
    daemon
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    option  http-server-close
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    retries 3
    option  redispatch

# ----------------------------------------------------------------------
# Frontend: Subscription Website (Port ${SUBSCRIPTION_SITE_PORT}, Obscured)
# ----------------------------------------------------------------------
frontend ft_subscription_site
    bind *:${SUBSCRIPTION_SITE_PORT} ssl crt ${HAPROXY_CERT_DIR}/${SUBSCRIPTION_DOMAIN}.pem alpn h2,http/1.1
    mode http
    option tcplog

    # ACLs first
    acl is_sub_page             path ${SUBSCRIPTION_BASE64_PATH}
    acl is_api_path             path_beg ${API_BASE64_PATH_PREFIX}/
    acl is_health_check         path /health

    # Rule ordering fix: http-request rules are processed before use_backend
    # Drop if NOT (is_sub_page OR is_api_path OR is_health_check)
    http-request silent-drop if !is_sub_page !is_api_path !is_health_check

    # Use backend if one of the allowed paths is matched (this rule is effectively after the drop)
    use_backend bk_subscription_app if is_sub_page or is_api_path or is_health_check

# ----------------------------------------------------------------------
# Backend: Subscription App (Flask/Gunicorn)
# ----------------------------------------------------------------------
backend bk_subscription_app
    mode http
    # CORRECTED httpchk: Ensure Host header is part of the request string properly
    option httpchk GET /health HTTP/1.1\\r\\nHost:\ ${SUBSCRIPTION_DOMAIN}
    default-server check fall 3 rise 2 inter 5s
    server sub_app_server 127.0.0.1:${SUBSCRIPTION_APP_LISTEN_PORT}

# ----------------------------------------------------------------------
# Frontend: VLESS (Port ${VLESS_HTTPUPGRADE_PORT}, Obscured Path)
# ----------------------------------------------------------------------
frontend ft_vless_tls
    bind *:${VLESS_HTTPUPGRADE_PORT} ssl crt ${HAPROXY_CERT_DIR}/${MAIN_DOMAIN}.pem alpn h2,http/1.1
    mode http
    option tcplog

    acl is_vless_path path ${VLESS_PATH}

    # Rule ordering fix:
    http-request silent-drop if !is_vless_path

    use_backend bk_vless if is_vless_path

# ----------------------------------------------------------------------
# Backend: VLESS (Sing-Box)
# ----------------------------------------------------------------------
backend bk_vless
    mode http
    server vless_server 127.0.0.1:${SINGBOX_VLESS_LISTEN_PORT}

# ----------------------------------------------------------------------
# Frontend: Hysteria2 (Port ${HYSTERIA2_PORT}, UDP Rate Limit)
# ----------------------------------------------------------------------
frontend ft_hysteria2
    # CORRECTED: Removed 'proto udp'
    bind *:${HYSTERIA2_PORT}
    mode tcp                # Use mode tcp for UDP packet forwarding
    option tcplog
    log global

    stick-table type ip size 1m expire 30s store conn_rate(10s)
    tcp-request connection track-sc0 src
    tcp-request connection reject if { sc0_conn_rate gt 10 }

    default_backend bk_hysteria2

# ----------------------------------------------------------------------
# Backend: Hysteria2 (Sing-Box)
# ----------------------------------------------------------------------
backend bk_hysteria2
    mode tcp # Must match frontend for this type of passthrough
    server hysteria2_server 127.0.0.1:${SINGBOX_HYSTERIA2_LISTEN_PORT}
# ======================================================================
# End of HAProxy Configuration Template
# ======================================================================
