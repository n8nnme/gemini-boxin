# ======================================================================
# HAProxy Configuration Template
# Version 1.1 (Fixes for forwardfor and httpchk, UDP bind)
# ======================================================================

global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners user ${HAPROXY_USER} group ${HAPROXY_GROUP}
    stats timeout 30s
    user ${HAPROXY_USER}
    group ${HAPROXY_GROUP}
    daemon
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

defaults
    log     global
    # mode    http # Keep this global default, can be overridden
    option  httplog
    option  dontlognull
    # option  forwardfor # REMOVED from global, will be added to HTTP sections
    option  http-server-close
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    retries 3
    option  redispatch

# --- Defaults for HTTP specific frontends/backends ---
defaults DEFAULTS_HTTP
    mode    http
    option  forwardfor # Apply forwardfor only to HTTP sections using these defaults

# ----------------------------------------------------------------------
# Frontend: Subscription Website (Port ${SUBSCRIPTION_SITE_PORT}, Obscured)
# ----------------------------------------------------------------------
frontend ft_subscription_site
    # Use HTTP specific defaults
    defaults DEFAULTS_HTTP
    bind *:${SUBSCRIPTION_SITE_PORT} ssl crt ${HAPROXY_CERT_DIR}/${SUBSCRIPTION_DOMAIN}.pem alpn h2,http/1.1
    # mode http (inherited from DEFAULTS_HTTP)
    option tcplog

    acl is_sub_page             path ${SUBSCRIPTION_BASE64_PATH}
    acl is_api_path             path_beg ${API_BASE64_PATH_PREFIX}/
    acl is_health_check         path /health

    http-request silent-drop if !is_sub_page !is_api_path !is_health_check
    use_backend bk_subscription_app if is_sub_page or is_api_path or is_health_check

# ----------------------------------------------------------------------
# Backend: Subscription App (Flask/Gunicorn)
# ----------------------------------------------------------------------
backend bk_subscription_app
    # Use HTTP specific defaults
    defaults DEFAULTS_HTTP
    # mode http (inherited from DEFAULTS_HTTP)
    option httpchk GET /health HTTP/1.1\\r\\nHost:\ ${SUBSCRIPTION_DOMAIN}
    default-server check fall 3 rise 2 inter 5s
    server sub_app_server 127.0.0.1:${SUBSCRIPTION_APP_LISTEN_PORT}

# ----------------------------------------------------------------------
# Frontend: VLESS (Port ${VLESS_HTTPUPGRADE_PORT}, Obscured Path)
# ----------------------------------------------------------------------
frontend ft_vless_tls
    # Use HTTP specific defaults
    defaults DEFAULTS_HTTP
    bind *:${VLESS_HTTPUPGRADE_PORT} ssl crt ${HAPROXY_CERT_DIR}/${MAIN_DOMAIN}.pem alpn h2,http/1.1
    # mode http (inherited from DEFAULTS_HTTP)
    option tcplog

    acl is_vless_path path ${VLESS_PATH}
    http-request silent-drop if !is_vless_path
    use_backend bk_vless if is_vless_path

# ----------------------------------------------------------------------
# Backend: VLESS (Sing-Box)
# ----------------------------------------------------------------------
backend bk_vless
    # Use HTTP specific defaults
    defaults DEFAULTS_HTTP
    # mode http (inherited from DEFAULTS_HTTP)
    server vless_server 127.0.0.1:${SINGBOX_VLESS_LISTEN_PORT}

# ----------------------------------------------------------------------
# Frontend: Hysteria2 (Port ${HYSTERIA2_PORT}, UDP Rate Limit)
# ----------------------------------------------------------------------
frontend ft_hysteria2
    # DOES NOT use DEFAULTS_HTTP
    bind *:${HYSTERIA2_PORT}
    mode tcp
    option tcplog # tcplog is fine for mode tcp
    log global

    stick-table type ip size 1m expire 30s store conn_rate(10s)
    tcp-request connection track-sc0 src
    tcp-request connection reject if { sc0_conn_rate gt 10 }

    default_backend bk_hysteria2

# ----------------------------------------------------------------------
# Backend: Hysteria2 (Sing-Box)
# ----------------------------------------------------------------------
backend bk_hysteria2
    # DOES NOT use DEFAULTS_HTTP
    mode tcp
    server hysteria2_server 127.0.0.1:${SINGBOX_HYSTERIA2_LISTEN_PORT}
# ======================================================================
# End of HAProxy Configuration Template
# ======================================================================
